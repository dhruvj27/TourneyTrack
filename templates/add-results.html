<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Add Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Navbar -->
   <nav class="bg-black text-white">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <!-- Left side -->
    <div class="flex items-center gap-8">
      <a href="{{ url_for('smc_dashboard') }}" class="text-sm hover:underline">← Back</a>
      <h1 class="text-lg font-semibold">Add Results</h1>
    </div>

    <!-- Right side -->
     <div class="flex items-center gap-4">
        <a href="{{ url_for('smc_dashboard') }}"
          class="text-sm bg-gray-500 px-3 py-1 rounded hover:bg-white/20">
          Dashboard
        </a>
     
     <a href="{{ url_for('logout') }}" 
   class="text-sm bg-white/10 px-3 py-1 rounded hover:bg-white/20">
  Logout
</a>
</div>
  </div>
</nav>

  <!-- Flash messages -->
  <div class="max-w-6xl mx-auto px-4 mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2">
          {% for category, message in messages %}
            <div class="px-4 py-2 rounded text-sm
              {% if category == 'success' %} bg-green-100 text-green-800
              {% elif category == 'error' %} bg-red-100 text-red-800
              {% else %} bg-blue-100 text-blue-800
              {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
  </div>

  <main class="max-w-6xl mx-auto px-4 py-6">

    {# --- helpers to map team PK id -> public team_id and name --- #}
    {% macro team_code(tid) -%}
      {%- for t in teams -%}
        {%- if t.id == tid -%}{{ t.team_id }}{%- endif -%}
      {%- endfor -%}
    {%- endmacro %}

    {% macro team_name(tid) -%}
      {%- for t in teams -%}
        {%- if t.id == tid -%}{{ t.name }}{%- endif -%}
      {%- endfor -%}
    {%- endmacro %}

    <!-- Add Results Form -->
    <section class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Enter Match Result</h2>

      {% if pending_matches and pending_matches|length > 0 %}
      <form method="POST" action="{{ url_for('add_results') }}" class="space-y-4" id="result-form">

        <!-- Select a pending match -->
        <div class="grid md:grid-cols-2 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Match</label>
            <select name="match_id" id="match_id" class="w-full border rounded p-2" required>
              <option value="" disabled selected>Select a match</option>
              {% for m in pending_matches %}
                {# derive safe labels whether or not relationships exist #}
                {% set t1n = m.team1.name if m.team1 else team_name(m.team1_id) %}
                {% set t2n = m.team2.name if m.team2 else team_name(m.team2_id) %}
                {% set t1c = team_code(m.team1_id) %}
                {% set t2c = team_code(m.team2_id) %}
                <option 
                  value="{{ m.id }}"
                  data-team1-id="{{ m.team1_id }}"
                  data-team2-id="{{ m.team2_id }}"
                  data-team1-name="{{ (t1n or 'Team 1')|e }}"
                  data-team2-name="{{ (t2n or 'Team 2')|e }}"
                  data-team1-code="{{ (t1c or '')|e }}"
                  data-team2-code="{{ (t2c or '')|e }}"
                >
                  {{ (t1c or 'T1') }} {{ (t1n and '(' ~ t1n ~ ')' ) or '' }} 
                  vs 
                  {{ (t2c or 'T2') }} {{ (t2n and '(' ~ t2n ~ ')' ) or '' }} 
                  • {{ m.date.strftime('%b %d, %Y') }} {{ m.time.strftime('%H:%M') }} @ {{ m.venue }}
                </option>
              {% endfor %}
            </select>
          </div>

        
          <div>
            <label id="label_team1" class="block text-sm font-medium mb-1">Team 1 Score</label>
            <input type="text" min="0" name="team1_score" class="w-full border rounded p-2" required />
          </div>
          <div>
            <label id="label_team2" class="block text-sm font-medium mb-1">Team 2 Score</label>
            <input type="text" min="0" name="team2_score" class="w-full border rounded p-2" required />
          </div>

          <!-- Winner dropdown -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Winner (optional – leave blank for draw)</label>
            <select name="winner_id" id="winner_id" class="w-full border rounded p-2">
              <option value="">— Draw / No winner —</option>
              <!-- JS will inject Team 1 and Team 2 options based on the selected match -->
            </select>
          </div>
        </div>

        <button class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">
          Save Result
        </button>
      </form>
      {% else %}
        <p class="text-gray-600">No pending matches that need results.</p>
      {% endif %}
    </section>

    <!-- Recently Completed -->
   <!-- Recently Completed -->
<section class="bg-white rounded-lg shadow p-6 mt-6">
  <h3 class="text-lg font-semibold mb-3">Recently Completed</h3>
  {% if completed_matches and completed_matches|length > 0 %}
    <ul class="divide-y">
      {% for m in completed_matches %}
        {% set t1n = m.team1.name if m.team1 else team_name(m.team1_id) %}
        {% set t2n = m.team2.name if m.team2 else team_name(m.team2_id) %}
        {% set t1c = team_code(m.team1_id) %}
        {% set t2c = team_code(m.team2_id) %}

        {% set wn = (m.winner.name if m.winner else team_name(m.winner_id)) if m.winner_id else None %}
        {% set wc = team_code(m.winner_id) if m.winner_id else None %}

        <li class="py-3">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <div class="font-medium">
              {{ (t1c or 'T1') }} {{ (t1n and '(' ~ t1n ~ ')') or '' }}
              {{ ' ' }} {{ m.team1_score if m.team1_score is not none else '-' }}
              &nbsp;–&nbsp;
              {{ m.team2_score if m.team2_score is not none else '-' }} {{ ' ' }}
              {{ (t2c or 'T2') }} {{ (t2n and '(' ~ t2n ~ ')') or '' }}
            </div>
            <div class="text-sm text-gray-600">
              {{ m.date.strftime('%b %d, %Y') }} • {{ m.time.strftime('%H:%M') }} • {{ m.venue }}
            </div>
          </div>
          <div class="text-sm mt-1">
            <span class="font-medium">Winner:</span>
            {% if m.winner_id %}
              {{ (wc or '') }} {{ (wn and '(' ~ wn ~ ')') or '' }}
            {% else %}
              Draw
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-gray-600">No completed matches yet.</p>
  {% endif %}
</section>

  </main>

  <script>
    // Populate score labels and winner options when a match is selected
    const matchSelect = document.getElementById('match_id');
    const label1 = document.getElementById('label_team1');
    const label2 = document.getElementById('label_team2');
    const winnerSel = document.getElementById('winner_id');

    function setWinnerOptions(opt) {
      // Clear everything except draw option
      for (let i = winnerSel.options.length - 1; i >= 1; i--) {
        winnerSel.remove(i);
      }
      const t1Id = opt.getAttribute('data-team1-id');
      const t2Id = opt.getAttribute('data-team2-id');
      const t1Name = opt.getAttribute('data-team1-name') || 'Team 1';
      const t2Name = opt.getAttribute('data-team2-name') || 'Team 2';
      const t1Code = opt.getAttribute('data-team1-code');
      const t2Code = opt.getAttribute('data-team2-code');

      const o1 = document.createElement('option');
      o1.value = t1Id;
      o1.textContent = (t1Code ? `${t1Code} (${t1Name})` : t1Name);
      winnerSel.appendChild(o1);

      const o2 = document.createElement('option');
      o2.value = t2Id;
      o2.textContent = (t2Code ? `${t2Code} (${t2Name})` : t2Name);
      winnerSel.appendChild(o2);
    }

    function onMatchChange() {
      const opt = matchSelect.options[matchSelect.selectedIndex];
      if (!opt || !opt.value) return;

      const t1Name = opt.getAttribute('data-team1-name') || 'Team 1';
      const t2Name = opt.getAttribute('data-team2-name') || 'Team 2';
      const t1Code = opt.getAttribute('data-team1-code');
      const t2Code = opt.getAttribute('data-team2-code');

      label1.textContent = (t1Code ? `${t1Code} (${t1Name})` : `${t1Name}`) + ' Score';
      label2.textContent = (t2Code ? `${t2Code} (${t2Name})` : `${t2Name}`) + ' Score';

      setWinnerOptions(opt);
    }

    matchSelect?.addEventListener('change', onMatchChange);
  </script>
</body>
</html>
