<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Results • {{ tournament.name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

  {% set is_smc_route = request.blueprint == 'smc' %}

  <nav class="bg-gray-900 text-white shadow">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="{{ url_for('smc.tournament_detail', tournament_id=tournament.id) }}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-white/10 text-sm hover:bg-white/20 transition">
          <span aria-hidden="true">←</span>
          <span>{{ tournament.name }}</span>
        </a>
        <span class="text-lg font-semibold">Add Results</span>
      </div>
      <div class="flex items-center gap-4 text-sm">
        <a href="{{ url_for('smc.dashboard') }}" class="hidden sm:inline hover:text-blue-300">Dashboard</a>
        <a href="{{ url_for('smc.notifications', status='active') }}" class="relative inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10 transition" aria-label="Notifications">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 01-3.46 0"></path>
          </svg>
          {% if unread_notification_count %}
            <span class="absolute -top-1 -right-1 inline-flex items-center justify-center min-w-[1.25rem] px-1 py-0.5 text-xs font-semibold bg-blue-500 text-white rounded-full">{{ unread_notification_count }}</span>
          {% endif %}
        </a>
        <a href="{{ url_for('auth.logout') }}" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/20 transition">Logout</a>
      </div>
    </div>
  </nav>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="max-w-5xl mx-auto w-full px-4 mt-6">
        <div class="space-y-2">
          {% for category, message in messages %}
            <div class="px-4 py-3 rounded border text-sm
              {% if category == 'success' %}bg-green-50 border-green-200 text-green-800
              {% elif category == 'error' %}bg-red-50 border-red-200 text-red-800
              {% elif category == 'warning' %}bg-amber-50 border-amber-200 text-amber-800
              {% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endwith %}

  <header class="max-w-5xl mx-auto w-full px-4 py-8 border-b border-gray-200">
    <h1 class="text-3xl font-semibold text-gray-900">Finalize match results</h1>
    <p class="text-sm text-gray-600 mt-2">Record scores and winners for completed fixtures. Draws are supported by leaving the winner empty.</p>
  </header>

  {% macro team_code(tid) -%}
    {%- for t in teams -%}
      {%- if t.id == tid -%}{{ t.team_id }}{%- endif -%}
    {%- endfor -%}
  {%- endmacro %}

  {% macro team_name(tid) -%}
    {%- for t in teams -%}
      {%- if t.id == tid -%}{{ t.name }}{%- endif -%}
    {%- endfor -%}
  {%- endmacro %}

  <main class="flex-grow max-w-5xl mx-auto w-full px-4 pb-12 space-y-8">
    <section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
      <h2 class="text-xl font-semibold text-gray-900">Enter result</h2>

      {% if pending_matches %}
        <form method="POST" action="{{ url_for('smc.add_results', tournament_id=tournament.id) if is_smc_route else url_for('add_results') }}" class="mt-6 space-y-5" id="result-form">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="match_id">Match<span class="text-red-500">*</span></label>
            <select name="match_id" id="match_id" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="" disabled selected>Select a match</option>
              {% for m in pending_matches %}
                {% set t1n = m.team1.name if m.team1 else team_name(m.team1_id) %}
                {% set t2n = m.team2.name if m.team2 else team_name(m.team2_id) %}
                {% set t1c = team_code(m.team1_id) %}
                {% set t2c = team_code(m.team2_id) %}
                <option value="{{ m.id }}" 
                        data-team1-id="{{ m.team1_id }}"
                        data-team2-id="{{ m.team2_id }}"
                        data-team1-name="{{ (t1n or 'Team 1')|e }}"
                        data-team2-name="{{ (t2n or 'Team 2')|e }}"
                        data-team1-code="{{ (t1c or '')|e }}"
                        data-team2-code="{{ (t2c or '')|e }}">
                  {{ (t1c or 'T1') }} {{ (t1n and '(' ~ t1n ~ ')') or '' }} vs {{ (t2c or 'T2') }} {{ (t2n and '(' ~ t2n ~ ')') or '' }} • {{ m.date.strftime('%b %d, %Y') }} {{ m.time.strftime('%H:%M') }} @ {{ m.venue }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="grid gap-4 md:grid-cols-2">
            <div>
              <label id="label_team1" class="block text-sm font-medium text-gray-700 mb-1">Team 1 score<span class="text-red-500">*</span></label>
              <input type="text" name="team1_score" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label id="label_team2" class="block text-sm font-medium text-gray-700 mb-1">Team 2 score<span class="text-red-500">*</span></label>
              <input type="text" name="team2_score" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="winner_id">Winner</label>
            <select name="winner_id" id="winner_id" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">— Draw / No winner —</option>
            </select>
          </div>

          <div class="grid gap-4 md:grid-cols-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1" for="match_status">Match status</label>
              <select name="match_status" id="match_status" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="completed">Completed</option>
                <option value="active">Active / In progress</option>
              </select>
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit" class="px-5 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 transition">Save result</button>
          </div>
        </form>
      {% else %}
        <p class="text-sm text-gray-500 mt-3">No matches are waiting for results. Once fixtures are played, they will appear here.</p>
      {% endif %}
    </section>

    <section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
      <h2 class="text-xl font-semibold text-gray-900">Recently completed</h2>
      {% if completed_matches %}
        <ul class="mt-4 space-y-3 text-sm text-gray-700">
          {% for m in completed_matches %}
            {% set t1n = m.team1.name if m.team1 else team_name(m.team1_id) %}
            {% set t2n = m.team2.name if m.team2 else team_name(m.team2_id) %}
            {% set t1c = team_code(m.team1_id) %}
            {% set t2c = team_code(m.team2_id) %}
            {% set wn = (m.winner.name if m.winner else team_name(m.winner_id)) if m.winner_id else None %}
            {% set wc = team_code(m.winner_id) if m.winner_id else None %}
            <li class="border border-gray-200 rounded-md px-4 py-3 bg-gray-50">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <p class="font-medium text-gray-900">
                  {{ (t1c or 'T1') }} {{ (t1n and '(' ~ t1n ~ ')') or '' }} {{ m.team1_score if m.team1_score is not none else '-' }}
                  –
                  {{ m.team2_score if m.team2_score is not none else '-' }} {{ (t2c or 'T2') }} {{ (t2n and '(' ~ t2n ~ ')') or '' }}
                </p>
                <span class="text-xs text-gray-500">{{ m.date.strftime('%b %d, %Y') }} • {{ m.time.strftime('%H:%M') }} • {{ m.venue }} • {{ m.duration_label }}</span>
              </div>
              <p class="text-xs text-gray-500 mt-2"><span class="font-medium text-gray-700">Winner:</span> {% if m.winner_id %}{{ (wc or '') }} {{ (wn and '(' ~ wn ~ ')') or '' }}{% else %}Draw{% endif %}</p>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-gray-500 mt-3">No completed matches recorded yet.</p>
      {% endif %}
    </section>
  </main>

  <footer class="bg-gray-900 text-gray-300 text-center text-sm py-4 mt-auto">© 2025 TourneyTrackers. All rights reserved.</footer>

  <script>
    const matchSelect = document.getElementById('match_id');
    const labelTeam1 = document.getElementById('label_team1');
    const labelTeam2 = document.getElementById('label_team2');
    const winnerSelect = document.getElementById('winner_id');

    function resetWinnerOptions(option) {
      while (winnerSelect.options.length > 1) {
        winnerSelect.remove(1);
      }

      if (!option) {
        return;
      }

      const team1Id = option.getAttribute('data-team1-id');
      const team2Id = option.getAttribute('data-team2-id');
      const team1Name = option.getAttribute('data-team1-name') || 'Team 1';
      const team2Name = option.getAttribute('data-team2-name') || 'Team 2';
      const team1Code = option.getAttribute('data-team1-code');
      const team2Code = option.getAttribute('data-team2-code');

      const team1Option = document.createElement('option');
      team1Option.value = team1Id;
      team1Option.textContent = team1Code ? `${team1Code} (${team1Name})` : team1Name;
      winnerSelect.appendChild(team1Option);

      const team2Option = document.createElement('option');
      team2Option.value = team2Id;
      team2Option.textContent = team2Code ? `${team2Code} (${team2Name})` : team2Name;
      winnerSelect.appendChild(team2Option);
    }

    function onMatchChange() {
      const selected = matchSelect?.options[matchSelect.selectedIndex];
      if (!selected || !selected.value) {
        resetWinnerOptions(null);
        return;
      }

      const team1Name = selected.getAttribute('data-team1-name') || 'Team 1';
      const team2Name = selected.getAttribute('data-team2-name') || 'Team 2';
      const team1Code = selected.getAttribute('data-team1-code');
      const team2Code = selected.getAttribute('data-team2-code');

      if (labelTeam1) {
        labelTeam1.textContent = `${team1Code ? team1Code + ' (' + team1Name + ')' : team1Name} score`;
      }
      if (labelTeam2) {
        labelTeam2.textContent = `${team2Code ? team2Code + ' (' + team2Name + ')' : team2Name} score`;
      }

      resetWinnerOptions(selected);
    }

    matchSelect?.addEventListener('change', onMatchChange);
  </script>

</body>
</html>
