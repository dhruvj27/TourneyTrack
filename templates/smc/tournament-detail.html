<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>{{ tournament.name }} • Tournament Detail</title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

	<nav class="bg-gray-900 text-white shadow">
		<div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
			<div class="flex items-center gap-3">
				<a href="{{ url_for('smc.dashboard') }}" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-white/10 text-sm font-medium hover:bg-white/20 transition" aria-label="Back to dashboard">
					<span aria-hidden="true">←</span>
					<span>SMC Dashboard</span>
				</a>
				<span class="text-lg font-semibold">{{ tournament.name }}</span>
			</div>
			<div class="flex items-center gap-4 text-sm">
				<a href="{{ url_for('smc.notifications', status='active') }}" class="relative inline-flex items-center justify-center p-2 rounded-full hover:bg-white/10 transition" aria-label="Notifications">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
						<path d="M13.73 21a2 2 0 01-3.46 0"></path>
					</svg>
					{% if unread_notification_count %}
						<span class="absolute -top-1 -right-1 inline-flex items-center justify-center min-w-[1.25rem] px-1 py-0.5 text-xs font-semibold bg-blue-500 text-white rounded-full">{{ unread_notification_count }}</span>
					{% endif %}
				</a>
				<a href="{{ url_for('auth.logout') }}" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/20 transition">Logout</a>
			</div>
		</div>
	</nav>

	{% with messages = get_flashed_messages(with_categories=true) %}
		{% if messages %}
			<div class="max-w-6xl mx-auto w-full px-4 mt-6">
				<div class="space-y-2">
					{% for category, message in messages %}
						<div class="px-4 py-3 rounded border text-sm
							{% if category == 'success' %}bg-green-50 border-green-200 text-green-800
							{% elif category == 'error' %}bg-red-50 border-red-200 text-red-800
							{% elif category == 'warning' %}bg-amber-50 border-amber-200 text-amber-800
							{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %}">
							{{ message }}
						</div>
					{% endfor %}
				</div>
			</div>
		{% endif %}
	{% endwith %}

	<header class="max-w-6xl mx-auto w-full px-4 py-8 border-b border-gray-200">
		<div class="flex flex-wrap items-start justify-between gap-6">
			<div class="space-y-2">
				<h1 class="text-3xl font-semibold text-gray-900">{{ tournament.name }}</h1>
				<p class="text-sm text-gray-600">{{ tournament.start_date.strftime('%b %d, %Y') }} – {{ tournament.end_date.strftime('%b %d, %Y') }} • Status: {{ tournament.status|capitalize }}</p>
				<p class="text-sm text-gray-600">Institution: {{ tournament.institution or 'Open to all' }}{% if tournament.location %} • Location: {{ tournament.location }}{% endif %}</p>
				<p class="text-xs text-gray-500">Created {{ tournament.created_at.strftime('%b %d, %Y') }} • Managed by {{ g.current_user.username }}</p>
			</div>
			<a href="{{ url_for('smc.schedule_matches', tournament_id=tournament.id) }}" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition">Manage Schedule</a>
		</div>
		{% if tournament.rules %}
			<div class="mt-4 border border-gray-200 rounded-lg bg-gray-50 p-4 text-sm text-gray-700 whitespace-pre-line">
				{{ tournament.rules }}
			</div>
		{% endif %}
	</header>

	<main class="flex-grow max-w-6xl mx-auto w-full px-4 pb-12 space-y-10">

		<section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-5">
			<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 text-center">
				<p class="text-xs uppercase text-gray-500 tracking-wide">Total Teams</p>
				<p class="mt-2 text-2xl font-semibold text-gray-900">{{ stats.total_teams }}</p>
			</div>
			<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 text-center">
				<p class="text-xs uppercase text-gray-500 tracking-wide">Active Teams</p>
				<p class="mt-2 text-2xl font-semibold text-gray-900">{{ stats.active_teams }}</p>
			</div>
			<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 text-center">
				<p class="text-xs uppercase text-gray-500 tracking-wide">Matches</p>
				<p class="mt-2 text-2xl font-semibold text-gray-900">{{ stats.total_matches }}</p>
			</div>
			<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 text-center">
				<p class="text-xs uppercase text-gray-500 tracking-wide">Upcoming</p>
				<p class="mt-2 text-2xl font-semibold text-blue-700">{{ stats.upcoming_matches }}</p>
			</div>
			<div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 text-center">
				<p class="text-xs uppercase text-gray-500 tracking-wide">Completed</p>
				<p class="mt-2 text-2xl font-semibold text-green-700">{{ stats.completed_matches }}</p>
			</div>
		</section>

		{% if bracket and bracket.format == 'league' %}
			<section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
				<h2 class="text-xl font-semibold text-gray-900 mb-4">League standings</h2>
				{% if standings %}
					<div class="overflow-x-auto">
						<table class="min-w-full text-sm text-left">
							<thead class="bg-gray-100 border-b">
								<tr>
									<th class="px-4 py-2 font-medium text-gray-700">Team</th>
									<th class="px-4 py-2 font-medium text-gray-700 text-right">Pts</th>
									<th class="px-4 py-2 font-medium text-gray-700 text-right">W</th>
									<th class="px-4 py-2 font-medium text-gray-700 text-right">D</th>
									<th class="px-4 py-2 font-medium text-gray-700 text-right">L</th>
									<th class="px-4 py-2 font-medium text-gray-700 text-right">GF</th>
									<th class="px-4 py-2 font-medium text-gray-700 text-right">GA</th>
									<th class="px-4 py-2 font-medium text-gray-700 text-right">GD</th>
								</tr>
							</thead>
							<tbody class="divide-y">
								{% for entry in standings %}
									<tr class="hover:bg-gray-50">
										<td class="px-4 py-2">
											<a href="{{ url_for('public.team_profile', team_id=entry.team.team_id) }}" class="font-medium text-gray-900 hover:text-blue-600">{{ entry.team.name }}</a>
										</td>
										<td class="px-4 py-2 text-right font-semibold text-gray-900">{{ entry.points }}</td>
										<td class="px-4 py-2 text-right text-gray-600">{{ entry.record.wins }}</td>
										<td class="px-4 py-2 text-right text-gray-600">{{ entry.record.draws }}</td>
										<td class="px-4 py-2 text-right text-gray-600">{{ entry.record.losses }}</td>
										<td class="px-4 py-2 text-right text-gray-600">{{ entry.goals_for }}</td>
										<td class="px-4 py-2 text-right text-gray-600">{{ entry.goals_against }}</td>
										<td class="px-4 py-2 text-right text-gray-600">{{ entry.goal_diff }}</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				{% else %}
					<p class="text-sm text-gray-500">Standings will appear after results are recorded.</p>
				{% endif %}
			</section>
		{% endif %}

		<section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
			<h2 class="text-xl font-semibold text-gray-900 mb-4">Management Actions</h2>
			<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
				<a href="{{ url_for('smc.register_team', tournament_id=tournament.id) }}" class="border border-gray-200 hover:bg-gray-100 transition rounded-lg px-4 py-4">
					<h3 class="text-lg font-semibold text-gray-900">Register or Invite Teams</h3>
					<p class="text-sm text-gray-600 mt-1">Onboard new teams directly or send invitations to managers.</p>
				</a>
				<a href="{{ url_for('smc.pending_teams', tournament_id=tournament.id) }}" class="border border-gray-200 hover:bg-gray-100 transition rounded-lg px-4 py-4">
					<h3 class="text-lg font-semibold text-gray-900">Review Join Requests</h3>
					<p class="text-sm text-gray-600 mt-1">Approve or decline teams waiting for your decision.</p>
				</a>
				<a href="{{ url_for('smc.configure_bracket', tournament_id=tournament.id) }}" class="border border-gray-200 hover:bg-gray-100 transition rounded-lg px-4 py-4">
					<h3 class="text-lg font-semibold text-gray-900">Configure Bracket</h3>
					<p class="text-sm text-gray-600 mt-1">Set tournament format, league scoring, and knockout seeds.</p>
				</a>
				<a href="{{ url_for('smc.schedule_matches', tournament_id=tournament.id) }}" class="border border-gray-200 hover:bg-gray-100 transition rounded-lg px-4 py-4">
					<h3 class="text-lg font-semibold text-gray-900">Schedule Matches</h3>
					<p class="text-sm text-gray-600 mt-1">Plan fixtures and avoid timing conflicts.</p>
				</a>
				<a href="{{ url_for('smc.add_results', tournament_id=tournament.id) }}" class="border border-gray-200 hover:bg-gray-100 transition rounded-lg px-4 py-4">
					<h3 class="text-lg font-semibold text-gray-900">Record Match Results</h3>
					<p class="text-sm text-gray-600 mt-1">Lock in scores to keep standings current.</p>
				</a>
				<a href="#teams-list" class="border border-gray-200 hover:bg-gray-100 transition rounded-lg px-4 py-4 {% if not tournament_teams %}pointer-events-none opacity-60{% endif %}">
					<h3 class="text-lg font-semibold text-gray-900">Browse Teams</h3>
					<p class="text-sm text-gray-600 mt-1">Scroll to the team roster section below.</p>
				</a>
			</div>
		</section>

		<section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
			<h2 class="text-xl font-semibold text-gray-900 mb-4">Pending Join Requests</h2>
			{% if pending_requests %}
				<div class="overflow-x-auto">
					<table class="min-w-full text-sm text-left">
						<thead class="bg-gray-100 border-b">
							<tr>
								<th class="px-4 py-2 font-medium text-gray-700">Team</th>
								<th class="px-4 py-2 font-medium text-gray-700">Requested</th>
								<th class="px-4 py-2 font-medium text-gray-700">Contact</th>
								<th class="px-4 py-2 font-medium text-gray-700 text-right">Review</th>
							</tr>
						</thead>
						<tbody class="divide-y">
							{% for assoc in pending_requests %}
								<tr class="hover:bg-gray-50">
									<td class="px-4 py-2">
										<p class="font-medium text-gray-900">{{ assoc.team.name }}</p>
										<p class="text-xs text-gray-500">ID {{ assoc.team.team_id }} • {{ assoc.team.department }}</p>
									</td>
									<td class="px-4 py-2 text-sm text-gray-600">{{ assoc.requested_at.strftime('%b %d, %Y') }}</td>
									<td class="px-4 py-2 text-sm text-gray-600">{{ assoc.team.manager_name }}{% if assoc.team.manager_contact %} • {{ assoc.team.manager_contact }}{% endif %}</td>
									<td class="px-4 py-2 text-right">
										<a href="{{ url_for('smc.pending_teams', tournament_id=tournament.id) }}" class="inline-flex items-center justify-center px-3 py-1 rounded bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700 transition">Review</a>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			{% else %}
				<p class="text-sm text-gray-500">No pending requests. Share your registration link to invite new teams.</p>
			{% endif %}
		</section>

		<section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
			<h2 class="text-xl font-semibold text-gray-900 mb-4">Invited Teams</h2>
			{% if invited_teams %}
				<ul class="space-y-3 text-sm text-gray-700">
					{% for assoc in invited_teams %}
						{% set team = assoc.team %}
						<li class="border border-blue-200 rounded-lg px-4 py-3 bg-blue-50 flex flex-wrap items-start justify-between gap-3">
							<div>
								{% if team %}
									<p class="font-medium text-blue-900">{{ team.name }}</p>
									<p class="text-xs text-blue-700 mt-1">Team ID: {{ team.team_id }} • Invited {{ assoc.requested_at.strftime('%b %d, %Y') }}</p>
								{% else %}
									<p class="font-medium text-blue-900">Invitation pending setup</p>
									<p class="text-xs text-blue-700 mt-1">Invited {{ assoc.requested_at.strftime('%b %d, %Y') }}</p>
								{% endif %}
							</div>
							<span class="text-xs uppercase tracking-wider px-3 py-1 rounded-full bg-blue-200 text-blue-900">Awaiting response</span>
							{% if team %}
								<div class="mt-3 flex flex-wrap gap-2 text-sm w-full sm:w-auto">
									<a href="{{ url_for('smc.view_team', team_id=team.team_id) }}" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition">View team profile</a>
									{% if not team.is_self_managed %}
										<a href="{{ url_for('smc.edit_team_as_smc', team_id=team.team_id) }}" class="px-3 py-1 rounded border border-emerald-200 text-emerald-700 hover:bg-emerald-50 transition">Edit roster</a>
									{% endif %}
								</div>
							{% endif %}
						</li>
					{% endfor %}
				</ul>
			{% else %}
				<p class="text-sm text-gray-500">No outstanding invitations. Invite an existing team from the manage teams page.</p>
			{% endif %}
		</section>

		<section id="teams-list" class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
			<h2 class="text-xl font-semibold text-gray-900 mb-4">Teams in this Tournament</h2>
			{% if tournament_teams %}
				<div class="grid gap-4 md:grid-cols-2">
					{% for assoc in tournament_teams %}
						{% set team = assoc.team %}
						<article class="border border-gray-200 rounded-lg p-4 bg-gray-50">
							<header class="flex items-start justify-between gap-3">
								<div>
									<h3 class="text-lg font-semibold text-gray-900">{{ team.name }}</h3>
									<p class="text-sm text-gray-600 mt-1">Team ID: {{ team.team_id }} • Department: {{ team.department }}</p>
								</div>
								{% if team and not team.is_self_managed %}
									<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">SMC managed</span>
								{% else %}
									<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">Team managed</span>
								{% endif %}
							</header>
							<p class="text-xs text-gray-500">Status: {{ assoc.status|capitalize }}</p>
							<div class="mt-3 flex flex-wrap gap-2 text-sm">
								<a href="{{ url_for('smc.view_team', team_id=team.team_id) }}" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition">View team profile</a>
								{% if team and not team.is_self_managed %}
									<a href="{{ url_for('smc.edit_team_as_smc', team_id=team.team_id) }}" class="px-3 py-1 rounded border border-emerald-200 text-emerald-700 hover:bg-emerald-50 transition">Edit roster</a>
								{% endif %}
							</div>
						</article>
					{% endfor %}
				</div>
			{% else %}
				<p class="text-sm text-gray-500">No teams registered yet. Use the actions above to invite or approve participants.</p>
			{% endif %}
		</section>

		{% if smc_managed_teams %}
		<section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
			<h2 class="text-xl font-semibold text-gray-900 mb-4">SMC-managed Teams</h2>
			<p class="text-sm text-gray-600 mb-4">These teams were created by your SMC account. Assign a manager when the handover is ready.</p>
			<div class="space-y-3">
				{% for assoc in smc_managed_teams %}
					{% set team = assoc.team %}
					<div class="flex flex-wrap items-center justify-between gap-3 border border-gray-200 rounded-lg px-4 py-3 bg-gray-50">
						<div>
							<p class="font-medium text-gray-900">{{ team.name }} • {{ team.team_id }}</p>
							<p class="text-xs text-gray-500">Current manager: {{ team.manager_name or 'Unassigned' }}</p>
						</div>
						<button type="button" class="px-3 py-1.5 rounded bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 transition" data-team="{{ team.team_id }}" data-open-assign>Assign manager</button>
					</div>
					<div class="hidden mt-3" data-assign-block="{{ team.team_id }}">
						<form method="POST" action="{{ url_for('smc.assign_manager', team_id=team.team_id) }}" class="flex flex-wrap items-center gap-2">
							<label class="text-sm text-gray-700" for="manager_username_{{ team.team_id }}">Manager username</label>
							<input id="manager_username_{{ team.team_id }}" name="manager_username" required class="flex-1 min-w-[12rem] border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter username" />
							<button type="submit" class="px-3 py-2 rounded bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 transition">Confirm</button>
							<button type="button" class="px-3 py-2 rounded border border-gray-300 text-sm text-gray-600 hover:bg-gray-100 transition" data-close-assign="{{ team.team_id }}">Cancel</button>
						</form>
					</div>
				{% endfor %}
			</div>
		</section>
		{% endif %}

		<section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
			<div class="flex flex-wrap items-center justify-between gap-3 mb-4">
				<h2 class="text-xl font-semibold text-gray-900">Upcoming Matches</h2>
				<a href="{{ url_for('public.tournament_detail', tournament_id=tournament.id) }}" class="text-sm text-blue-600 hover:text-blue-700">Public view →</a>
			</div>
			{% if upcoming_matches %}
				<ul class="space-y-3 text-sm text-gray-700">
					{% for match in upcoming_matches %}
						<li class="border border-gray-200 rounded-lg px-4 py-3 bg-gray-50">
							<div class="font-medium text-gray-900">{{ match.versus_display }}</div>
							<div class="text-xs text-gray-500 mt-1">{{ match.date.strftime('%b %d, %Y') }} at {{ match.time.strftime('%H:%M') }} • {{ match.venue }} • {{ match.duration_label }}</div>
							<div class="text-xs text-gray-400">Round {{ match.round_number or '—' }}{% if match.stage %} • {{ match.stage }}{% endif %}</div>
						</li>
					{% endfor %}
				</ul>
			{% else %}
				<p class="text-sm text-gray-500">No upcoming matches scheduled. Add fixtures once participating teams are confirmed.</p>
			{% endif %}
		</section>

		<section class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
			<h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Results</h2>
			{% if completed_matches %}
				<ul class="space-y-3 text-sm text-gray-700">
					{% for match in completed_matches %}
						<li class="border border-gray-200 rounded-lg px-4 py-3 bg-white">
							<div class="font-medium text-gray-900">{{ match.versus_display }}</div>
							<div class="text-xs text-gray-500 mt-1">Played {{ match.date.strftime('%b %d, %Y') }} at {{ match.venue }} • {{ match.duration_label }}</div>
							<div class="text-xs text-gray-600 mt-1">{{ match.score_display }}</div>
							<div class="text-xs text-gray-600">{{ match.result_display }}</div>
						</li>
					{% endfor %}
				</ul>
			{% else %}
				<p class="text-sm text-gray-500">No results recorded yet. Publish completed match scores to keep followers informed.</p>
			{% endif %}
		</section>

	</main>

	<footer class="bg-gray-900 text-gray-300 text-center text-sm py-4 mt-auto">
		© 2025 TourneyTrackers. All rights reserved.
	</footer>

	<script>
		document.querySelectorAll('[data-open-assign]').forEach((button) => {
			button.addEventListener('click', () => {
				const target = button.dataset.team;
				const block = document.querySelector(`[data-assign-block="${target}"]`);
				if (block) {
					block.classList.remove('hidden');
				}
			});
		});

		document.querySelectorAll('[data-close-assign]').forEach((button) => {
			button.addEventListener('click', () => {
				const target = button.dataset.closeAssign;
				const block = document.querySelector(`[data-assign-block="${target}"]`);
				if (block) {
					block.classList.add('hidden');
				}
			});
		});
	</script>

</body>
</html>
